package cveparser

import (
	"encoding/json"
	"testing"

	"github.com/stretchr/testify/require"
)

func TestCVSParse(t *testing.T) {
	sampleCVEItem := []byte(`{"cve":{"data_type":"CVE","data_format":"MITRE","data_version":"4.0","CVE_data_meta":{"ID":"CVE-2022-3819","ASSIGNER":"cve@gitlab.com"},"problemtype":{"problemtype_data":[{"description":[]}]},"references":{"reference_data":[{"url":"https://gitlab.com/gitlab-org/cves/-/blob/master/2022/CVE-2022-3819.json","name":"https://gitlab.com/gitlab-org/cves/-/blob/master/2022/CVE-2022-3819.json","refsource":"CONFIRM","tags":[]},{"url":"https://gitlab.com/gitlab-org/gitlab/-/issues/365847","name":"https://gitlab.com/gitlab-org/gitlab/-/issues/365847","refsource":"MISC","tags":[]}]},"description":{"description_data":[{"lang":"en","value":"An improper authorization issue in GitLab CE/EE affecting all versions from 15.0 prior to 15.3.5, 15.4 prior to 15.4.4, and 15.5 prior to 15.5.2 allows a malicious users to set emojis on internal notes they don't have access to."}]}},"configurations":{"CVE_data_version":"4.0","nodes":[]},"impact":{},"publishedDate":"2022-11-10T00:15Z","lastModifiedDate":"2022-11-10T00:33Z"}`)
	var cveItem Item

	if err := json.Unmarshal(sampleCVEItem, &cveItem); err != nil {
		t.Fatal(err)
	}

	require.Equal(t, cveItem.LastModifiedDate, "2022-11-10T00:33Z")
	require.Equal(t, cveItem.PublishedDate, "2022-11-10T00:15Z")
	require.Equal(t, cveItem.Configurations.DataVersion, "4.0")
	require.Zero(t, len(cveItem.Configurations.Nodes))
	require.Equal(t, cveItem.CVE.DataType, "CVE")
	require.Equal(t, cveItem.CVE.DataFormat, "MITRE")
	require.Equal(t, cveItem.CVE.DataVersion, "4.0")
	require.Equal(t, cveItem.CVE.CVEMeta.ID, "CVE-2022-3819")
	require.Equal(t, cveItem.CVE.CVEMeta.Assigner, "cve@gitlab.com")
	require.Equal(t, len(cveItem.CVE.ProblemType.TypeData), 1)
	require.Zero(t, len(cveItem.CVE.ProblemType.TypeData[0].Description))
	require.Equal(t, len(cveItem.CVE.References.ReferenceData), 2)
	require.Equal(t, cveItem.CVE.References.ReferenceData[0].Url, "https://gitlab.com/gitlab-org/cves/-/blob/master/2022/CVE-2022-3819.json")
	require.Equal(t, cveItem.CVE.References.ReferenceData[0].Name, "https://gitlab.com/gitlab-org/cves/-/blob/master/2022/CVE-2022-3819.json")
	require.Equal(t, cveItem.CVE.References.ReferenceData[0].RefSource, "CONFIRM")
	require.Zero(t, len(cveItem.CVE.References.ReferenceData[0].Tags))
	require.Equal(t, cveItem.CVE.References.ReferenceData[1].Url, "https://gitlab.com/gitlab-org/gitlab/-/issues/365847")
	require.Equal(t, cveItem.CVE.References.ReferenceData[1].Name, "https://gitlab.com/gitlab-org/gitlab/-/issues/365847")
	require.Equal(t, cveItem.CVE.References.ReferenceData[1].RefSource, "MISC")
	require.Zero(t, len(cveItem.CVE.References.ReferenceData[1].Tags))
	require.Equal(t, len(cveItem.CVE.Description.DescriptionMeta), 1)
	require.Equal(t, cveItem.CVE.Description.DescriptionMeta[0].Lang, "en")
	require.Equal(t, cveItem.CVE.Description.DescriptionMeta[0].Value, "An improper authorization issue in GitLab CE/EE affecting all versions from 15.0 prior to 15.3.5, 15.4 prior to 15.4.4, and 15.5 prior to 15.5.2 allows a malicious users to set emojis on internal notes they don't have access to.")
}
